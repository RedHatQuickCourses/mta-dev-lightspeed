= Lab 4: Deploying the Migrated App on JBoss EAP 8

In this lab, you apply the changes to migrate the **Coolstore** application to **Jakarta EE**.
You rebuild the container image using **JBoss EAP 8**, deploy it on OpenShift, and validate that the modernized application functions as expected.

This step completes the migration journey, demonstrating how a legacy enterprise Java application can be successfully transformed and redeployed on a modern, supported runtime—without disrupting the underlying container platform.

== Instructions

* _Prepare and Build the Migrated Application_

1. For the purpose of this lab, you may clone the pre-migrated version of the application, which already includes the required changes to migrate from the javax namespace to the Jakarta EE libraries. This repository is provided to streamline the lab experience and allow you to focus on deployment and validation.
+
[source,subs="verbatim,quotes",bash]
----
**git clone https://github.com/opentraining-labs-customizations/getting-started-migrated.git**

**cd getting-started-migrated**
----

2. Navigate to the directory containing the cloned source code.
+
[source,subs="verbatim,quotes",bash]
----
**cd getting-started-migrated**
----

3. Update the Keycloak configuration to match your Red Hat OpenShift environment. Edit the following file and replace the placeholder <GUID> with your OpenShift cluster identifier.
+
[source,subs="verbatim,quotes",bash]
----
**vi coolstore/src/main/webapp/keycloak.json**
{
    "realm": "eap",
    "auth-server-url": "https://keycloak-coolstore-eap8.apps.cluster-**<GUID>**.dynamic.redhatworkshops.io/",
    "ssl-required": "external",
    "resource": "eap-app",
    "public-client": true,
    "confidential-port": 0
}
----

4. Build the application using Maven so that the updated configuration is included in the deployable artifact.
+
[source,subs="verbatim,quotes",bash]
----
**mvn clean package -pl coolstore -am**
----

5. Verify that the application archive has been successfully generated.
+
[source,subs="verbatim,quotes",bash]
----
**ls coolstore/target/ROOT.war**
----

* _Deploy the updated Coolstore Application on OpenShift (JBoss EAP 8)_

1. Navigate to the repository that contains the OpenShift resources and deployment configuration for JBoss EAP 8 and copy the newly built application WAR file into the deployment repository.
+
[source,subs="verbatim,quotes",bash]
----
**cd mta-dev-lightspeed**

**ls**
eap7_coolstore  eap8_coolstore

cp getting-started-migrated/coolstore/target/ROOT.war eap8_coolstore/00-eap8-coolstore-image
----

2. Navigate to the image build directory and create the required BuildConfig and ImageStream for JBoss EAP 7.
+
[source,subs="verbatim,quotes",bash]
----
**cd eap8_coolstore/00-eap8-coolstore-image**

**oc create -f 00-bc-is.yaml**
namespace/coolstore-eap8 created
buildconfig.build.openshift.io/coolstore-eap81 created
imagestream.image.openshift.io/coolstore-eap81 created
----
+
Verify that the resources have been created successfully.
+
[source,subs="verbatim,quotes",bash]
----
**oc project coolstore-eap8**
Now using project "coolstore-eap8" on server "https://api.cluster-6f2l2.dynamic.redhatworkshops.io:6443".

**oc get bc**
NAME              TYPE     FROM     LATEST
coolstore-eap81   Docker   Binary   0

**oc get is**
NAME              IMAGE REPOSITORY                                                                  TAGS   UPDATED
coolstore-eap81   image-registry.openshift-image-registry.svc:5000/coolstore-eap8/coolstore-eap81
----

4. Start a binary build using the copied application artifact.
+
[source,subs="verbatim,quotes",bash]
----
**oc start-build coolstore-eap81 --from-dir=. --follow**
----

5. Navigate back to the main deployment directory and deploy the PostgreSQL database along with its service.
+
[source,subs="verbatim,quotes",bash]
----
**cd mta-dev-lightspeed/eap8_coolstore**

**oc create -f 01-postgresql-deploy-svc.yaml**
deployment.apps/postgres created
service/postgres created
----

6. Verify that the database deployment and service are running.
+
[source,subs="verbatim,quotes",bash]
----
**oc get deployment**
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
postgres   1/1     1            1           2m21s

**oc get svc**
NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
postgres   ClusterIP   172.31.185.74   <none>        5432/TCP   2m32s
----

* _Configure and Deploy Keycloak_

1. Create a ConfigMap containing the Keycloak realm configuration.
+
[source,subs="verbatim,quotes",bash]
----
**oc create configmap keycloak-realm --from-file=realm-export.json**
configmap/keycloak-realm created

**oc get configmap keycloak-realm**
NAME             DATA   AGE
keycloak-realm   1      20s
----

2. Edit the Keycloak deployment file and replace <GUID> with your OpenShift cluster identifier.
+
[source,subs="verbatim,quotes",bash]
----
** vi 02-keyclaok-deploy-svc-route.yaml**
...
            - name: KC_PROXY
              value: edge
            - name: KC_HOSTNAME
              value: keycloak-coolstore-eap8.apps.cluster-<GUID>.dynamic.redhatworkshops.io
            - name: KC_HOSTNAME_STRICT
              value: "false"
            - name: KC_HTTP_ENABLED
              value: "true"
...
----

3. Deploy Keycloak and confirm that all associated resources are created successfully.
+
[source,subs="verbatim,quotes",bash]
----
**oc create -f 02-keyclaok-deploy-svc-route.yaml**
imagestream.image.openshift.io/keycloak-rhbk created
deployment.apps/keycloak created
service/keycloak created
route.route.openshift.io/keycloak created
job.batch/keycloak-bootstrap created

**oc get deployment/keycloak**
NAME       READY   UP-TO-DATE   AVAILABLE   AGE
keycloak   1/1     1            1           31s

**oc get svc/keycloak**
NAME       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
keycloak   ClusterIP   172.31.102.14   <none>        8080/TCP   42s

**oc get route/keycloak**
NAME       HOST/PORT                                                               PATH   SERVICES   PORT   TERMINATION     WILDCARD
keycloak   keycloak-coolstore-eap8.apps.cluster-6f2l2.dynamic.redhatworkshops.io          keycloak   http   edge/Redirect   None
----

4. Create a job to provision a default Keycloak user (user1 / redhat) required by the application.
+
[source,subs="verbatim,quotes",bash]
----
**oc create -f 03-keycloak-job.yaml**
job.batch/keycloak-bootstrap created

**oc get jobs**
NAME                 STATUS     COMPLETIONS   DURATION   AGE
keycloak-bootstrap   Complete   1/1           9s         17s
----

* _Deploy the Coolstore Application_

1. Deploy the Coolstore application along with its service and route.
+
[source,subs="verbatim,quotes",bash]
----
**oc create -f 04-coolstore.yaml**
deployment.apps/coolstore created
service/coolstore created
route.route.openshift.io/coolstore created
----

2. Verify that the application has been deployed successfully and is accessible.
+
[source,subs="verbatim,quotes",bash]
----
**oc get deployment/coolstore**
NAME        READY   UP-TO-DATE   AVAILABLE   AGE
coolstore   1/1     1            1           77s

**oc get svc/coolstore**
NAME        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
coolstore   ClusterIP   172.31.133.182   <none>        8080/TCP   89s

**oc get route/coolstore*
NAME        HOST/PORT                                                                PATH   SERVICES    PORT   TERMINATION   WILDCARD
coolstore   coolstore-coolstore-eap8.apps.cluster-6f2l2.dynamic.redhatworkshops.io          coolstore   8080   edge          None
----

3. Access the application route URL to verify that the legacy application has been successfully deployed and is running.
+
image::image4.png[align="center"]

4. Validate the Keycloak integration by clicking the **Sign In** button on the application landing page.
+
image::image2.png[align="center"]

5. Log in using the credentials **username: user1** and **password: redhat**, and confirm that authentication succeeds and the application is redirected to the main application interface.
+
image::image3.png[align="center"]
+
**Voilà!** You have successfully migrated the JBoss EAP 7 application from the legacy javax-based codebase to a JBoss EAP 8 application using the Jakarta EE platform.